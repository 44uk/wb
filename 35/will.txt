Quick Beのメモリーリーク修正＆Vista対応パッチの作成

■0x00.) はじめに

　今回はブログで少し書いたQuick Beのメモリーリークについて
　詳しくとまではいきませんが、その修正方法について書いてみました。
　Vistaでなくてもエラーの検出は出来るのですが、Vistaの方が分かりやすい
　と言うことで今回についてはVista環境を想定しています。
　なお、必要な物として以下のソフトウェアが必要です。
　OllyDbgについては既に日本語化済みとして話しを進めます。
　・OllyDbg　http://www.ollydbg.de/
　・Quick Be Build 011　http://cowscorpion.com/file/QuickBe.html

■0x01.) Quick Beとは

krackをしている人ならば知らない人はいないと思いますが
Quick Beはいわゆる、日本ではバイナリエディタ、海外ではhexadecimal editor
などと呼ばれているソフトウェアです。


■0x02.) なぜ修正するのか？

Windows Vista上でQuick Beを動作させた場合「パッチファイル実行」の
「書き換えるファイルが存在するフォルダ」を選択すると落ちます。
他のWindowsでも落ちはしませんが、以下の様なログを残します。

-----
 ﾒｯｾｰｼﾞ=デバッグ文字列: Invalid Address specified to RtlFreeHeap( 130000, 7d08e150 )
-----

と言うわけで自分で修正してみましょう。


■0x03.) 修正

（注意）以下の作業はVistaで行います。

まず、OllyDbgでQuick Beを開き、実行させます。そしてフォルダを選択すると
ntdllの中で一時停止し、さらに進めると終了してしまいます。
という訳で再スタートし、トレース実行を行います。
再びフォルダを選択し、停止したところでラントレースを見ます。
ntdllに入る前に実行されたのが

-----
0040E185  FF15 30564100 CALL NEAR DWORD PTR DS:[<&ole32.CoTaskMe>;  ole32.CoTaskMemFree
-----

だと言うのが分かります。つまりこの関数が原因です。
そして、これのどこが駄目なのかというとその前のPUSH EAXです。
本来ならばSHBrowseForFolderの戻り値を引数にして呼び出す必要があるのですが、
SHGetPathFromIDListを呼び出す前に戻り値を退避させていないので、その戻り値で
上書きされています。
という訳で修正したいのですが、かなり詰まっています。
空いてる所にジャンプしてから修正するのがいいかも知れませんが、
今回はパッチ数を減らす方向で修正しましょう。
そういう訳でエラー処理の

-----
TEST EAX,EAX
JE 0040E9AF
-----
を消して使うことにします。

上記のコードを

-----
MOV DWORD PTR SS:[ESP+14],EAX
-----

に変更します。
後はファイルに保存するだけです。
以上でQuick Beの修正は終わりです。

■0x04.) 駄文

時間は有るけどネタがないと言うことで、再度しょぼい文章を書かしていただきましたｗ
今度出す時はもう少しましな事を書きたいと思います。
と思い続けて最早不可能だと気づきました。
ではでは。

